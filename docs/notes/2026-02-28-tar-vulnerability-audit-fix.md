# Tar Vulnerability and npm Audit Fix

## Summary

`npm audit` reports 2 high-severity vulnerabilities in the `tar` package (transitive dependency of `fastembed`). This note documents the outcome of applying `npm audit fix --force` and the constraints that prevent a clean resolution.

## What Was Done

1. **Ran `npm audit fix --force`** as requested. This downgraded `fastembed` from 2.1.0 to 1.0.0.
2. **Build failed**: `fastembed@1.0.0` is a different, minimal package with no `FlagEmbedding` or `EmbeddingModel` exports. The real fastembed (from fastembed-js) is 2.x.
3. **Reverted fastembed to ^2.1.0** and attempted to fix the vulnerability via npm `overrides` to force `tar@^7.5.8`.
4. **Override broke fastembed**: Tar 7.x uses named exports only; fastembed does `import tar from "tar"` (default import). Error: "The requested module 'tar' does not provide an export named 'default'".
5. **Removed the tar override** so fastembed works with tar 6.x. All 60 tests pass.

## Resolution (2026-02-28)

Phase 3 of the embedder options plan applied a patch (patch-package) to fastembed: change tar import to support tar 7.x named exports. With npm override `"tar": "^7.5.8"` and the patch, `npm audit` reports 0 vulnerabilities. All tests pass. See `docs/notes/2026-02-28-transformers-js-and-local-embedder-options.md`.

## Why Tar 7.x Cannot Be Used

- `fastembed` (from fastembed-js) depends on `tar ^6.2.0`.
- Tar 7.x has a breaking API change: no default export. Fastembed uses `import tar from "tar"`.
- The fastembed-js repository is archived (Jan 2026), so upstream fixes are unlikely.

## Options for Future

1. **Fork fastembed-js** and update the tar import to support tar 7.x (e.g. `import * as tar from "tar"` or use named imports).
2. **Switch embedder** to a library that does not depend on tar (e.g. Transformers.js, or an external embedding service).
3. **Accept the risk** for now; tar is used by fastembed only for model download/extraction. The vulnerability affects tar extraction; if the model cache is trusted, exposure may be limited.
